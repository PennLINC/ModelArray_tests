---
title: "create voxel data with NAs for testing"
author: "Chenying Zhao"
output: html_document
---

This is to create voxel data with NAs (e.g. subject-specific mask) for CircleCI testing for ModelArray.\
WARNING: this is not generated by ConVoxel, so there could be inconsistency between ConVoxel's generated .h5 file vs this one. Here we're mainly targeting for values in the scalar matrix.
```{r libraries, include = FALSE}
rm(list=ls())
library(ModelArray)
library(rhdf5)
library(hdf5r)
library(testthat)
```

```{r create h5}
nsubj <- 40    # 40, 60 (because 50*relative_thr = 50*20% = 10 = absolute_thr)
nvoxels <- 100
dim <- c(10,10,10)
scalar_name <- "FA"

list.num.valid.subj <- c(0, 0.3*nsubj, 0.2*nsubj, 0.1*nsubj,
                            12, 10, 8)

num.subj.lthr.abs <- 10
num.subj.lthr.rel <- 0.2

# the h5 file to create
folder.h5 <- "/home/chenying/Desktop/fixel_project/data/data_forCircleCI_voxeldata_wNAs"
fn.h5 <- file.path(folder.h5, 
                   paste0("n", toString(nsubj), "_voxels.h5"))


```

```{r expect test results}
# whether there are sufficient subjects; if so = 1, if not = NA
list.results <- rep(0, length(list.num.valid.subj))
for (i in 1:length(list.num.valid.subj)) {
  num.valid.subjects <- list.num.valid.subj[i]
  if ((num.valid.subjects > num.subj.lthr.abs) & (num.valid.subjects > num.subj.lthr.rel * nsubj)) {   # both are "greater than" ">"
    list.results[i] = 1
  } else {
    list.results[i] = NA
  }
}
list.results
```

```{r create the h5 file}
if (file.exists(fn.h5)) {
  unlink(fn.h5)   # remove existing one
}
h5 <- hdf5r::H5File$new(fn.h5, mode="a")
```

```{r create group voxels}
voxels <- cbind(0:(nvoxels-1),   # voxel_id, starting from 0
                rep(5, nvoxels),   # assume it's on the same x slice
                rep(1:10, nvoxels/10),    # 1,2,....10, 1,2,...10,...
                rep(1:10, each = nvoxels/10))   # 1,1,1,1,...,2,2,2,.....
mode(voxels) <- "integer"   # convert into integer
h5[["voxels"]] <- voxels
```

```{r create group scalars}
# scalars:
scalars.grp <- h5$create_group("scalars")
thescalar.grp <- scalars.grp$create_group(scalar_name)


for (i in 1:length(list.num.valid.subj)) {
  expect_lte(list.num.valid.subj[i], nsubj)
}

# generate scalar_mat based on list.num.valid.subj (for first several voxels):
scalar_mat <- rep(NaN, nsubj)   # all NAs
for (i in 2:length(list.num.valid.subj)) {
  toadd <- c(runif(list.num.valid.subj[i]),     # random number between 0-1, #=listed in the list
             rep(NA,  (nsubj - list.num.valid.subj[i])  ))    # the rest = NA
  scalar_mat <- rbind(scalar_mat, toadd)
}
rownames(scalar_mat) <- NULL

temp <- nvoxels - length(list.num.valid.subj)   # rest of the voxels: all valid
toadd <- matrix(runif( temp  * nsubj  ), nrow=temp)
scalar_mat <- rbind(scalar_mat, toadd)
rownames(scalar_mat) <- NULL

thescalar.grp[["values"]] <- scalar_mat


# add source filenames as the column_names:
list.source_file <- paste("FA/subj", as.character(1:nsubj), sep="") 
hdf5r::h5attr(thescalar.grp[["values"]], "column_names") <- list.source_file

h5$close_all()

h5ls(fn.h5)
```

